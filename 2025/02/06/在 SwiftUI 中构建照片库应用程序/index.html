<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>在 SwiftUI 中构建照片库应用程序 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="你好！欢迎来到 CodeWithChris 的新文章系列！在本系列中，我将分享我在 SwiftUI 中构建简单的照片库应用程序的个人经验。 – 伊纳基·纳西索 (Iñaki Narciso) 撰写，2022 年 9 月 20 日  目录  介绍 第 1 部分：使用 PhotoKit 进行内存管理 第 2 部分：照片网格 UI 的内存管理实践 第 3 部分：创建照片库应用程序 第 4 部分：添加多个">
<meta property="og:type" content="article">
<meta property="og:title" content="在 SwiftUI 中构建照片库应用程序">
<meta property="og:url" content="http://example.com/2025/02/06/%E5%9C%A8%20SwiftUI%20%E4%B8%AD%E6%9E%84%E5%BB%BA%E7%85%A7%E7%89%87%E5%BA%93%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="你好！欢迎来到 CodeWithChris 的新文章系列！在本系列中，我将分享我在 SwiftUI 中构建简单的照片库应用程序的个人经验。 – 伊纳基·纳西索 (Iñaki Narciso) 撰写，2022 年 9 月 20 日  目录  介绍 第 1 部分：使用 PhotoKit 进行内存管理 第 2 部分：照片网格 UI 的内存管理实践 第 3 部分：创建照片库应用程序 第 4 部分：添加多个">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/106976715/187477387-701f70b9-adc7-416f-b8e1-3d0c4ac8c860.png">
<meta property="og:image" content="https://docs-assets.developer.apple.com/published/a84db79dea/50390428-f9f2-4cbc-bd99-1cacca4f0617.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/106976715/189639356-ab043d14-b5ac-4217-a19f-cd655f43ef33.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/106976715/190696381-a2ff87d0-c2cf-4a37-b558-cc8a812ab380.png">
<meta property="article:published_time" content="2025-02-06T05:41:40.000Z">
<meta property="article:modified_time" content="2025-02-06T05:44:58.546Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/106976715/187477387-701f70b9-adc7-416f-b8e1-3d0c4ac8c860.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-在 SwiftUI 中构建照片库应用程序" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/02/06/%E5%9C%A8%20SwiftUI%20%E4%B8%AD%E6%9E%84%E5%BB%BA%E7%85%A7%E7%89%87%E5%BA%93%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" class="article-date">
  <time class="dt-published" datetime="2025-02-06T05:41:40.000Z" itemprop="datePublished">2025-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      在 SwiftUI 中构建照片库应用程序
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>你好！欢迎来到 CodeWithChris 的新文章系列！在本系列中，我将分享我在 SwiftUI 中构建简单的照片库应用程序的个人经验。</p>
<p>– 伊纳基·纳西索 (Iñaki Narciso) 撰写，2022 年 9 月 20 日</p>
<p> <strong>目录</strong></p>
<ol>
<li><strong>介绍</strong></li>
<li><a target="_blank" rel="noopener" href="https://codewithchris.com/photo-gallery-app-swiftui-part-1">第 1 部分：使用 PhotoKit 进行内存管理</a></li>
<li><a target="_blank" rel="noopener" href="https://codewithchris.com/photo-gallery-app-swiftui-part-2">第 2 部分：照片网格 UI 的内存管理实践</a></li>
<li><a target="_blank" rel="noopener" href="https://codewithchris.wpengine.com/photo-gallery-app-swiftui-part-3/">第 3 部分：创建照片库应用程序</a></li>
<li><a target="_blank" rel="noopener" href="https://codewithchris.wpengine.com/photo-gallery-app-swiftui-part-4/">第 4 部分：添加多个手势</a></li>
</ol>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>你好！欢迎来到 CodeWithChris 的新文章系列！在本系列中，我将分享我在 SwiftUI 中构建简单的照片库应用程序的个人经验。</p>
<p>在我们继续之前，我想让您知道我无论如何都不是 SwiftUI 专家。几个月前我开始了我的 SwiftUI 学习之旅，但我在 UIKit 方面有很好的经验。您可以看到我到处添加一些 UIKit 参考资料，但照片库应用程序的所有代码以及本系列的内容都是 100% SwiftUI 编写的。</p>
<p>本系列分为多篇文章，我们将涵盖构建照片库应用程序的不同主题和技术。我建议您按顺序阅读本系列，以便您在阅读本系列时可以更清楚地掌握进展情况。</p>
<p>在本系列中，我们将使用<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/photokit">PhotoKit</a>来访问用户的照片库并获取将在应用程序中显示的照片。 PhotoKit 是 Apple 的框架，允许开发人员使用照片应用程序管理的图像和视频资源，包括来自 iCloud 照片和实时照片的图像和视频资源。</p>
<p>我们还将讨论<strong>内存管理</strong>等重要主题。照片往往会快速消耗内存，尤其是在具有大型用户库的网格 UI 中显示时。我们将讨论照片如何消耗内存、内存管理不佳的问题以及如何使用 PhotoKit 为我们处理这些内存管理问题。</p>
<p>我们将使用一个特定的 SwiftUI 视图在网格界面中显示用户的照片库 - <strong>LazyVGrid</strong> 。它有一个内置的内存管理机制，仅在必要时才加载其子视图，因此加载大型库不会导致大量的内存使用。然而，单独使用这种内存管理机制不足以支持照片库应用程序的内存需求。我们将在本系列文章中介绍其中的原因。</p>
<p>照片库应用程序将采用 100% SwiftUI 构建。当我们开发这个应用程序时，不会包含任何 UIKit 视图。然而，我们将讨论<strong>UICollectionViewController</strong>和<strong>UICollectionViewCells</strong>的一些重要的内存管理机制，它们是 UIKit 中相当于<strong>LazyVGrid</strong>的机制。</p>
<p>我们将发现两者之间的关键区别，并利用这种学习来改进我们的<strong>LazyVGrid</strong>视图，以提高内存性能。这听起来可能相当复杂，但解决方案却出奇的简单。</p>
<p>在构建内存性能照片网格 UI 后，我们将详细介绍如何构建照片详细视图。详细视图将显示以黑色背景视图为中心的照片。我们还将添加对<strong>DragGesture</strong> 、 <strong>MagnificationGesture</strong>和<strong>TapGesture</strong>等手势的支持，以添加更精细的控件，使用户能够更详细地检查照片。我们还将讨论添加手势的挑战，例如在视图范围内平移缩放照片。</p>
<p>我很高兴向您展示我在构建此应用程序时学到的所有知识，并且希望您也能喜欢学习它！</p>
<h3 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h3><p>您无需成为 SwiftUI 大师即可阅读本系列，但需要具备 SwiftUI 的基础知识。</p>
<p>您也不需要有任何 UIKit 经验。我们不会在代码中使用任何 UIKit，但本系列后面会有一个关于 UIKit 视图的内存管理机制的主题。这些只是为了解释我们开发应用程序时至关重要的概念。我将尽力尽可能简单地解释 UIKit 概念。</p>
<p>如果您在学习本系列文章时遇到困难，我建议您首先完成我们的<a target="_blank" rel="noopener" href="https://learn.codewithchris.com/courses/start">14 天初学者挑战，</a>以帮助您开始使用 SwiftUI。</p>
<h3 id="接下来"><a href="#接下来" class="headerlink" title="接下来"></a>接下来</h3><p>本系列的第 1 部分将向您展示如何为 PhotoKit 创建一个服务层，这将为我们做两件事。第一个是询问用户访问照片库的权限，第二个是从库中获取并缓存照片。我们还将探讨如果没有适当的内存管理，可能会出现什么问题。希望这也能让您兴奋地学习。我们下一场见！</p>
<h1 id="第-1-部分：使用-PhotoKit-进行内存管理"><a href="#第-1-部分：使用-PhotoKit-进行内存管理" class="headerlink" title="第 1 部分：使用 PhotoKit 进行内存管理"></a>第 1 部分：使用 PhotoKit 进行内存管理</h1><p>您好，欢迎回来！这是“在 SwiftUI 中构建照片库应用程序”系列的 4 部分中的第 1 部分。在这篇文章中，我们将讨论内存管理。内存是一种非常重要的资源，因为它被许多应用程序（包括系统本身）共享。</p>
<p>您好，欢迎回来！这是<strong>在 SwiftUI 中构建照片库应用程序</strong>系列的 4 部分中的第 1 部分。</p>
<p>在这篇文章中，我们将讨论内存管理。内存是一种非常重要的资源，因为它被许多应用程序（包括系统本身）共享。如果您不小心，照片会很快消耗内存，并且一次加载整个库将导致内存的过度使用。应用程序崩溃和性能低下是内存管理不良最常见的影响。</p>
<h3 id="数码照片的剖析"><a href="#数码照片的剖析" class="headerlink" title="数码照片的剖析"></a>数码照片的剖析</h3><p>单张照片的内存消耗取决于以下因素：</p>
<ol>
<li><strong>分辨率</strong>——显示照片所需的像素总数</li>
<li><strong>压缩</strong>– 通常由文件类型决定，图像的压缩将根据其颜色空间和不透明度及其节省内存的策略来确定渲染图像需要多少字节。最常见的压缩类型是 JPEG（有损压缩）和 PNG（无损压缩）。我不会更详细地讨论两者之间的差异，但图像压缩是决定内存中图像总大小的因素之一。</li>
</ol>
<p>假设我们从现代 12MP 相机（例如 iPhone 13 相机）拍摄一张照片。生成的照片的分辨率为<strong>4290 x 2800</strong> 。仅分辨率就需要总共 1200 万像素才能完全渲染照片。假设我们不使用压缩算法来减小大小，但支持 alpha 透明度信息 (ARGB) – 这意味着我们需要 8 位来表示 alpha 透明度，8 位来表示红色信息，8 位来表示蓝色信息颜色信息，8位表示绿色信息。每个像素的颜色空间和透明度信息总共需要 32 位（ARGB 各 8 位）才能完全渲染其颜色。</p>
<p>因此，要渲染全彩色照片，我们需要 1200 万像素乘以每个像素的 32 位颜色 &#x3D; 384Mbits（兆位），大约为 48MB（兆字节：8 位 &#x3D; 1 字节）。理论上，一张没有压缩格式的现代照片每张将花费 48Mb。其中 10 张照片将花费 480Mb。一百个将花费 4.8Gb。你明白了。</p>
<p>假设普通 iPhone 用户的照片库中总共可以有 25,000 张照片，以与上例相同的分辨率加载所有不带压缩格式的照片理论上需要 1.2Tb 内存。如果我们选择一次性加载所有内容，现代 iPhone 都无法处理。</p>
<p>实际上，采用 JPEG 或 PNG 等现代压缩格式的照片成本要低得多，但即使照片因压缩而尺寸较小，加载整个库在内存中仍然非常昂贵。</p>
<h3 id="在照片库应用程序中管理内存"><a href="#在照片库应用程序中管理内存" class="headerlink" title="在照片库应用程序中管理内存"></a>在照片库应用程序中管理内存</h3><ol>
<li><strong>按需加载照片</strong>– 仅在必要时将照片存储在内存中。在照片库应用中，即使用户的照片库很大，一次也只能显示少量照片。当用户滚动浏览图库时，应该从内存中释放经过滚动区域的照片，并且仅加载要显示的新照片。</li>
<li><strong>避免直接引用照片</strong>- 由于照片消耗内存的速度非常快，因此我们需要避免在代码中直接引用它们，而仅通过 ID 或 URL 引用它们。直接引用照片可能会导致内存重复，我们不希望单张照片在我们的内存中多次存在。由于我们想要使用 PhotoKit 从用户的库中获取照片，因此我们可以使用资产 ID 间接引用照片。如果我们需要在屏幕上加载照片，我们可以告诉 PhotoKit 获取并缓存照片，并让该套件为我们处理所有内存管理。</li>
<li><strong>避免内存中的照片重复</strong>- 将照片从一个屏幕传递到另一个屏幕时，我们不应该传递照片本身的副本。我们可以将照片的引用作为 ID（如果使用 PhotoKit）或 URL（如果从缓存或网络获取）发送。</li>
<li><strong>有效利用磁盘缓存</strong>- 从库或网络获取照片需要时间。为了加快下次需要显示照片时的加载速度，您应该将其缓存到磁盘。在 PhotoKit 中，这是由照片缓存管理器处理的。当您第一次告诉 PhotoKit 获取照片时，缓存管理器会自动将照片缓存在磁盘上，这样下次需要时加载照片的时间就会更短。但要小心！缓存是易失性的 - 这意味着它只会在应用程序处于活动状态时将照片保留在缓存中。如果应用程序关闭或终止，缓存中的照片将会丢失。缓存从网络获取的照片是另一回事，因为您可以灵活地调整自己的缓存策略。</li>
</ol>
<h3 id="使用照片套件"><a href="#使用照片套件" class="headerlink" title="使用照片套件"></a>使用照片套件</h3><p>PhotoKit 是一个 Apple 框架，允许我们的应用程序处理由“照片”应用程序管理的照片和视频资源。这还包括由 iCloud Photos 和 Live Photos 管理的照片和视频，但我们的照片库应用程序中不需要这些。</p>
<p>为了抽象所有 PhotoKit 代码，我创建了一个服务，它将为我们执行以下操作：</p>
<ol>
<li><strong>请求访问照片库</strong>- 为了从照片库中获取照片，用户需要向应用程序授予此访问权限。</li>
<li><strong>从图库中获取照片</strong>- 一旦获得访问权限，我们就可以获取可以在应用程序中显示的照片。获取将包括设置限制（例如出于隐私原因排除隐藏的照片）和设置排序顺序（例如首先显示最新的照片）。</li>
<li><strong>缓存获取的照片</strong>– 应缓存所有获取的照片，以便下次我们需要向用户显示它时加载时间会更少。</li>
</ol>
<h4 id="请求访问用户的照片库"><a href="#请求访问用户的照片库" class="headerlink" title="请求访问用户的照片库"></a>请求访问用户的照片库</h4><p>为了请求访问，我们首先需要存储用户授予的当前权限。我们可以稍后向 PhotoKit 询问确切的权限，但现在，让我们从<code>.notDetermined</code>开始。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Photos</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoLibraryService</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="comment">/// The permission status granted by the user</span></span><br><span class="line">	<span class="comment">/// This property will determine if we need to request</span></span><br><span class="line">	<span class="comment">/// for library access or not</span></span><br><span class="line">    <span class="keyword">var</span> authorizationStatus: <span class="type">PHAuthorizationStatus</span> <span class="operator">=</span> .notDetermined</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是添加显示访问用户照片库的请求的功能。该函数将采用一个可选的错误关闭参数，以便我们可以允许 UI 在用户决定不授予照片库访问权限时显示错误。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoLibraryService</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="keyword">func</span> <span class="title function_">requestAuthorization</span>(</span><br><span class="line">        <span class="params">handleError</span>: ((<span class="type">AuthorizationError</span>?) -&gt; <span class="type">Void</span>)<span class="operator">?</span> <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">    ) &#123;</span><br><span class="line">	    <span class="comment">/// This is the code that does the permission requests</span></span><br><span class="line">        <span class="type">PHPhotoLibrary</span>.requestAuthorization &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] status <span class="keyword">in</span></span><br><span class="line">	        <span class="keyword">self</span><span class="operator">?</span>.authorizationStatus <span class="operator">=</span> status</span><br><span class="line">	        <span class="comment">/// We can determine permission granted by the status</span></span><br><span class="line">            <span class="keyword">switch</span> status &#123;</span><br><span class="line">            <span class="comment">/// Fetch all photos if the user granted us access</span></span><br><span class="line">            <span class="comment">/// This won&#x27;t be the photos themselves but the</span></span><br><span class="line">            <span class="comment">/// references only.</span></span><br><span class="line">            <span class="keyword">case</span> .authorized, .limited:</span><br><span class="line">                <span class="keyword">self</span><span class="operator">?</span>.fetchAllPhotos()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/// For denied response, we should show an error</span></span><br><span class="line">            <span class="keyword">case</span> .denied, .notDetermined, .restricted:</span><br><span class="line">                handleError<span class="operator">?</span>(.restrictedAccess)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">@unknown</span> <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>authorizationStatus</code>属性，我们可以确定应用程序是否需要请求访问照片库，并使用<code>requestAuthorization()</code>函数本身执行实际的权限请求。</p>
<h4 id="从图库中获取照片"><a href="#从图库中获取照片" class="headerlink" title="从图库中获取照片"></a>从图库中获取照片</h4><p>现在我们已经有了一种方法来请求用户访问照片库的权限，接下来我们需要做的就是找到一种从照片库中获取照片参考的方法。</p>
<p>让我们首先添加一个变量来存储我们的获取结果。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoLibraryService</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">	<span class="comment">/// https://stackoverflow.com/a/69755543</span></span><br><span class="line">	<span class="comment">/// A collection that allows subscript support to</span></span><br><span class="line">	<span class="comment">/// PHFetchResult&lt;PHAsset&gt;</span></span><br><span class="line">	<span class="comment">///</span></span><br><span class="line">	<span class="comment">/// The results property will store all of the photo asset ids </span></span><br><span class="line">	<span class="comment">/// that we requested, and will be used by our views to request </span></span><br><span class="line">	<span class="comment">/// for a copy of the photo itself.</span></span><br><span class="line">	<span class="comment">///</span></span><br><span class="line">    <span class="comment">/// We don&#x27;t want to store a copy of the actual photo as it would </span></span><br><span class="line">    <span class="comment">/// cost too much memory, especially if we show the photos in a</span></span><br><span class="line">    <span class="comment">/// grid.</span></span><br><span class="line">	<span class="meta">@Published</span> <span class="keyword">var</span> results <span class="operator">=</span> <span class="type">PHFetchResultCollection</span>(</span><br><span class="line">		fetchResult: .<span class="keyword">init</span>()</span><br><span class="line">	)</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PHFetchResultCollection</code>是<code>PHFetchResult&lt;PHAsset&gt;</code>的集合包装器，但支持下标访问。稍后当我们需要创建网格 UI 时，我们将使用下标访问。</p>
<p>我们还需要一个<code>PHCachingImageManager</code>来为我们执行实际的照片获取和缓存。让我们将其添加到属性声明列表旁边：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoLibraryService</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="comment">/// The manager that will fetch and cache photos for us</span></span><br><span class="line">    <span class="keyword">var</span> imageCachingManager <span class="operator">=</span> <span class="type">PHCachingImageManager</span>()</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在有一个属性来存储我们的获取结果和一个管理器来为我们获取和缓存照片。让我们继续编写函数，告诉管理器从库中获取所有照片引用，并将它们存储在我们的 results 属性中。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoLibraryService</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    <span class="comment">/// Function that will tell the image caching manager to fetch </span></span><br><span class="line">    <span class="comment">/// all photos from the user&#x27;s photo library. We don&#x27;t want to </span></span><br><span class="line">    <span class="comment">/// include hidden assets for obvious privacy reasons.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// We also need to sort the photos being fetched by the most </span></span><br><span class="line">    <span class="comment">/// recent first, mimicking the behaviour of the Recents album </span></span><br><span class="line">    <span class="comment">/// from the Photos app.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">fetchAllPhotos</span>() &#123;</span><br><span class="line">        imageCachingManager.allowsCachingHighQualityImages <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">let</span> fetchOptions <span class="operator">=</span> <span class="type">PHFetchOptions</span>()</span><br><span class="line">        fetchOptions.includeHiddenAssets <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        fetchOptions.sortDescriptors <span class="operator">=</span> [</span><br><span class="line">            <span class="type">NSSortDescriptor</span>(key: <span class="string">&quot;creationDate&quot;</span>, ascending: <span class="literal">false</span>)</span><br><span class="line">        ]</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            <span class="keyword">self</span>.results.fetchResult <span class="operator">=</span> <span class="type">PHAsset</span>.fetchAssets(with: .image, options: fetchOptions)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的函数仅获取照片参考，而不是实际照片本身。这是 PhotoKit 的内存管理机制之一，因为它仅在请求时才加载照片的图像。要使用图像资源 ID 实际加载图像，我们需要编写另一个接受图像资源 ID 并返回图像类型的函数。由于照片库应用程序将使用 100% SwiftUI 编写，因此我们将使用 SwiftUI <code>Image</code>在 UI 中渲染照片，而且 PhotoKit 返回<code>UIImage</code>实例是一件好事，因为 SwiftUI <code>Image</code>支持它。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Photos</span><br><span class="line"><span class="keyword">import</span> UIKit <span class="comment">// Don&#x27;t forget to add this</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoLibraryService</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">    <span class="comment">/// Requests an image copy given a photo asset id.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The image caching manager performs the fetching, and will </span></span><br><span class="line">    <span class="comment">/// cache the photo fetched for later use. Please know that the </span></span><br><span class="line">    <span class="comment">/// cache is temporary – all photos cached will be lost when the</span></span><br><span class="line">    <span class="comment">/// app is terminated.</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">fetchImage</span>(</span><br><span class="line">        <span class="params">byLocalIdentifier</span> <span class="params">localId</span>: <span class="type">PHAssetLocalIdentifier</span>,</span><br><span class="line">        <span class="params">targetSize</span>: <span class="type">CGSize</span> <span class="operator">=</span> <span class="type">PHImageManagerMaximumSize</span>,</span><br><span class="line">        <span class="params">contentMode</span>: <span class="type">PHImageContentMode</span> <span class="operator">=</span> .default</span><br><span class="line">    ) <span class="keyword">async</span> <span class="keyword">throws</span> -&gt; <span class="type">UIImage</span>? &#123;</span><br><span class="line">        <span class="keyword">let</span> results <span class="operator">=</span> <span class="type">PHAsset</span>.fetchAssets(</span><br><span class="line">            withLocalIdentifiers: [localId],</span><br><span class="line">            options: <span class="literal">nil</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> asset <span class="operator">=</span> results.firstObject <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">QueryError</span>.phAssetNotFound</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> options <span class="operator">=</span> <span class="type">PHImageRequestOptions</span>()</span><br><span class="line">        options.deliveryMode <span class="operator">=</span> .opportunistic</span><br><span class="line">        options.resizeMode <span class="operator">=</span> .fast</span><br><span class="line">        options.isNetworkAccessAllowed <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        options.isSynchronous <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> <span class="keyword">await</span> withCheckedThrowingContinuation &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] continuation <span class="keyword">in</span></span><br><span class="line">	        <span class="comment">/// Use the imageCachingManager to fetch the image</span></span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.imageCachingManager.requestImage(</span><br><span class="line">                for: asset,</span><br><span class="line">                targetSize: targetSize,</span><br><span class="line">                contentMode: contentMode,</span><br><span class="line">                options: options,</span><br><span class="line">                resultHandler: &#123; image, info <span class="keyword">in</span></span><br><span class="line">	                <span class="comment">/// image is of type UIImage</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> info<span class="operator">?</span>[<span class="type">PHImageErrorKey</span>] <span class="keyword">as?</span> <span class="type">Error</span> &#123;</span><br><span class="line">                        continuation.resume(throwing: error)</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    continuation.resume(returning: image)</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>PHCachingImageManager</code>实例的好处是，当它第一次获取照片时，它也会缓存照片。因此，当我们需要在其他时间获取照片时，加载速度会快得多！我们也不需要担心缓存策略和缓存的内存管理，因为 PhotoKit 已经为我们处理了这一切！</p>
<p>现在我们有了一个可以轻松使用的<code>PhotoLibraryService</code>类，让我们将它作为<code>environmentObject</code>依赖项添加到我们的 App 文件中，这样我们就可以轻松地从我们的视图中访问它。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"></span><br><span class="line"><span class="keyword">@main</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoGalleryApp</span>: <span class="title class_">App</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> photoLibraryService <span class="operator">=</span> <span class="type">PhotoLibraryService</span>()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">Scene</span> &#123;</span><br><span class="line">		<span class="type">WindowGroup</span> &#123;</span><br><span class="line">			<span class="type">PhotoLibraryView</span>() <span class="comment">// This is what we&#x27;ll do next</span></span><br><span class="line">				.environmentObject(photoLibraryService)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这篇文章中，您了解了照片库应用程序内存管理的基本要求，以及如何使用 PhotoKit 为我们进行获取、缓存和内存管理工作。</p>
<p>在下一篇文章中，我们将继续从用户界面的角度讨论内存管理，并且我们还将开始构建照片网格的 UI。现在就这些了。我们下一场见！</p>
<h1 id="第-2-部分：照片网格-UI-的内存管理实践"><a href="#第-2-部分：照片网格-UI-的内存管理实践" class="headerlink" title="第 2 部分：照片网格 UI 的内存管理实践"></a>第 2 部分：照片网格 UI 的内存管理实践</h1><p>在这篇文章中，我们将从用户界面的角度继续讨论内存管理。 UI 将在网格中显示照片，因此应用内存管理实践非常重要，这样当我们滚动照片时应用程序的内存消耗就不会增加。</p>
<p>您好，欢迎回来！这是<strong>在 SwiftUI 中构建照片库应用程序</strong>系列的 4 部分中的第 2 部分。</p>
<p>在本系列的第 1 部分中，我们讨论了照片库应用程序内存管理的基本要求。我们还讨论了如何使用 PhotoKit 为我们完成所有内存管理繁重工作。管理内存非常重要，特别是因为我们将在照片库应用程序中显示大量照片。我们不希望应用程序因内存管理不善而崩溃或执行缓慢。</p>
<p>在这篇文章中，我们将从用户界面的角度继续讨论内存管理。 UI 将在网格中显示照片，因此应用内存管理实践非常重要，这样当我们滚动照片时应用程序的内存消耗就不会增加。</p>
<h3 id="用户界面"><a href="#用户界面" class="headerlink" title="用户界面"></a>用户界面</h3><img src="https://user-images.githubusercontent.com/106976715/187477387-701f70b9-adc7-416f-b8e1-3d0c4ac8c860.png" width="360">

<p>我们要创建的用户界面类似于上面的屏幕截图 - 来自用户照片库的照片网格。对于纵向的 iPhone，网格将有 3 列行。每张照片都将被中心裁剪并包含在方形<code>Image</code> SwiftUI 视图中。我们将使用包裹在<code>ScrollView</code>中的<code>LazyVGrid</code> ，这样我们就可以在更多图像加载到网格中时滚动。</p>
<h3 id="惰性网格"><a href="#惰性网格" class="headerlink" title="惰性网格"></a>惰性网格</h3><p><code>LazyVGrid</code> SwiftUI 视图有一个内置的内存管理机制，仅在需要时加载其元素（因此，有“lazy”关键字）。这种行为对于照片库应用程序来说是理想的选择，因为用户可以拥有一个相当大的照片库。 <code>LazyVGrid</code>将仅加载需要在屏幕上显示的照片，因此照片仅按需添加到内存中。然而，延迟加载的内存管理机制是不够的，因为加载到内存中但滚动经过视图区域的照片将保留在内存中。</p>
<p>随着时间的推移，随着新照片加载到内存中并在滚动区域中查看，内存消耗会不断累积，直到系统内存耗尽，从而导致应用程序运行缓慢，或更严重的是崩溃。</p>
<p>管理照片网格 UI 内存消耗的理想机制是：</p>
<ol>
<li>在需要显示照片时加载照片，最好从缓存中加载。</li>
<li>释放超出滚动区域的照片。</li>
</ol>
<p><code>LazyVGrid</code>涵盖了机制#1，但缺少机制#2。为了避免用户滚动时内存随着时间的推移而积累，我们必须添加 UIKit 视图熟悉的新内存管理机制，例如单元格重用机制。</p>
<h3 id="UICollectionView-Cell-复用机制"><a href="#UICollectionView-Cell-复用机制" class="headerlink" title="UICollectionView Cell 复用机制"></a>UICollectionView Cell 复用机制</h3><p>在 UIKit 中，与<code>LazyVGrid</code> SwiftUI 视图最接近的等效项是使用以下任一视图的<code>UICollectionView</code> <code>UICollectionViewFlowLayout (iOS 12 below)</code> 或一个 <code>UICollectionViewCompositionalLayout (iOS 13 and later)</code> 。</p>
<img src="https://docs-assets.developer.apple.com/published/a84db79dea/50390428-f9f2-4cbc-bd99-1cacca4f0617.png" width= "650" >

<p>单元重用的想法是一次加载多个在网格上可见的单元，并在单元隐藏在视图之外时立即从内存中释放这些单元。当用户继续滚动到网格或列表中时，从内存中释放的单元格稍后将被重新使用以显示其他项目。</p>
<p>细胞重用的想法非常简单。如果屏幕上可以同时显示 20 个项目，则即使您有 100 万个项目要在屏幕上显示，一次也只会加载 20 个单元格。当任何单元格经过滚动区域时，它们应该从内存中释放，因为它们不再显示在屏幕上。释放的单元格将被另一个项目重复使用以显示在屏幕上。这个机制做了两个有效的事情来管理内存：</p>
<ol>
<li>屏幕上一次仅显示有限数量的单元格并加载到内存中</li>
<li>无论您的 UI 需要显示的项目数量有多少，您都保证拥有有限数量的单元格。</li>
</ol>
<h3 id="将单元重用机制应用于LazyVGrid"><a href="#将单元重用机制应用于LazyVGrid" class="headerlink" title="将单元重用机制应用于LazyVGrid"></a>将单元重用机制应用于LazyVGrid</h3><p>将单元格重用机制应用于<code>LazyVGrid</code>的解决方案非常简单。我们可以在<code>GridItem</code>上使用<code>.onDisappear()</code>修饰符，以便每次调用修饰符时都会释放图像。</p>
<p>为此，我们需要创建<code>GridItem</code>并将其命名为<code>PhotoThumbnailView</code> 。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Photos</span><br><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The photo thumbnail view is responsible for showing a photo </span></span><br><span class="line"><span class="comment">/// in the photo grid.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoThumbnailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PhotoThumbnailView</code>应包含一张可选照片，我们可以稍后从内存中释放该照片。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoThumbnailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="comment">/// The image view that will render the photo that we&#x27;ll be </span></span><br><span class="line">	<span class="comment">/// fetching. It is set to optional since we don&#x27;t have an actual </span></span><br><span class="line">	<span class="comment">/// photo when this view starts to render.</span></span><br><span class="line">    <span class="comment">/// </span></span><br><span class="line">    <span class="comment">/// We need to give time for the photo library service to </span></span><br><span class="line">    <span class="comment">/// fetch a copy of the photo using the asset id, so </span></span><br><span class="line">    <span class="comment">/// we&#x27;ll set the image with the fetched photo at a later time.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Fetching make take time, especially if the photo has been </span></span><br><span class="line">    <span class="comment">/// requested initially. However, photos that were successfully </span></span><br><span class="line">    <span class="comment">/// fetched are cached, so any fetching from that point forward</span></span><br><span class="line">    <span class="comment">/// will be fast.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Also, we would want to free up the image from the memory when </span></span><br><span class="line">    <span class="comment">/// this view disappears in order</span></span><br><span class="line">    <span class="comment">/// to save up memory.</span></span><br><span class="line">    <span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> image: <span class="type">Image</span>?</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们将使用<code>PhotoKit</code>从照片库中获取照片，因此我们需要存储照片的资源本地 ID，以便我们可以告诉照片库服务我们需要它的副本才能显示到我们的 UI 中。</p>
<p>让我们将<code>PhotoLibraryService</code>添加为<code>PhotoThumbnailView</code>的依赖项。在第 1 部分中，创建<code>PhotoLibraryService</code>是为了将所有与 PhotoKit 相关的代码抽象到单个服务层中。如果您还没有阅读过，请查看本系列的第 1 部分。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoThumbnailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    <span class="comment">/// We&#x27;ll use the photo library service to fetch a photo given an </span></span><br><span class="line">    <span class="comment">/// asset id, and cache it for later use. If the photo is already </span></span><br><span class="line">    <span class="comment">/// cached, a cached copy will be provided instead.</span></span><br><span class="line">    <span class="comment">/// </span></span><br><span class="line">    <span class="comment">/// Ideally, we don&#x27;t want to store a reference to an image </span></span><br><span class="line">    <span class="comment">/// itself and pass it around views as it would cost memory.</span></span><br><span class="line">    <span class="comment">/// We&#x27;ll use the asset id instead as a reference, and allow the </span></span><br><span class="line">    <span class="comment">/// photo library&#x27;s cache to handle any memory management for us.</span></span><br><span class="line">    <span class="meta">@EnvironmentObject</span> <span class="keyword">var</span> photoLibraryService: <span class="type">PhotoLibraryService</span></span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们已经将照片库服务作为依赖项，我们需要添加一个属性来保存照片的本地资源 ID，我们将使用该 ID 来获取照片的副本。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoThumbnailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="comment">/// The reference id of the selected photo</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> assetLocalId: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">assetLocalId</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.assetLocalId <span class="operator">=</span> assetLocalId</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们将定义一个函数，该函数将使用<code>PhotoLibraryService</code>的更简单的抽象从<code>PhotoKit</code>实际加载资源。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoThumbnailView</span> &#123;</span><br><span class="line">	<span class="keyword">func</span> <span class="title function_">loadImageAsset</span>(</span><br><span class="line">		<span class="params">targetSize</span>: <span class="type">CGSize</span> <span class="operator">=</span> <span class="type">PHImageManagerMaximumSize</span></span><br><span class="line">	) <span class="keyword">async</span> &#123;</span><br><span class="line">	        <span class="keyword">guard</span> <span class="keyword">let</span> uiImage <span class="operator">=</span> <span class="keyword">try?</span> <span class="keyword">await</span> photoLibraryService</span><br><span class="line">	        .fetchImage(</span><br><span class="line">		        byLocalIdentifier: assetLocalId,</span><br><span class="line">		        targetSize: targetSize</span><br><span class="line">			) <span class="keyword">else</span> &#123;</span><br><span class="line">	            image <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">		        <span class="keyword">return</span></span><br><span class="line">		    &#125;</span><br><span class="line">	    image <span class="operator">=</span> <span class="type">Image</span>(uiImage: uiImage)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是创建<code>PhotoThumbnailView</code>的实际<code>body</code>并使用我们迄今为止所学到的知识，包括单元重用内存管理机制。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoThumbnailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">ZStack</span> &#123;</span><br><span class="line">            <span class="comment">// Show the image if it&#x27;s available</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> image <span class="operator">=</span> image &#123;</span><br><span class="line">                <span class="type">GeometryReader</span> &#123; proxy <span class="keyword">in</span></span><br><span class="line">                    image</span><br><span class="line">                        .resizable()</span><br><span class="line">                        .aspectRatio(contentMode: .fill)</span><br><span class="line">                        .frame(</span><br><span class="line">	                        width: proxy.size.width, </span><br><span class="line">	                        height: proxy.size.width</span><br><span class="line">	                    )</span><br><span class="line">                        .clipped()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// We&#x27;ll also make sure that the photo will </span></span><br><span class="line">                <span class="comment">// be square</span></span><br><span class="line">                .aspectRatio(<span class="number">1</span>, contentMode: .fit)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Otherwise, show a gray rectangle with a </span></span><br><span class="line">                <span class="comment">// spinning progress view</span></span><br><span class="line">                <span class="type">Rectangle</span>()</span><br><span class="line">                    .foregroundColor(.gray)</span><br><span class="line">                    .aspectRatio(<span class="number">1</span>, contentMode: .fit)</span><br><span class="line">                <span class="type">ProgressView</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We need to use the task to work on a concurrent request to </span></span><br><span class="line">        <span class="comment">// load the image from the photo library service, which </span></span><br><span class="line">        <span class="comment">// is asynchronous work.</span></span><br><span class="line">        .task &#123;</span><br><span class="line">            <span class="keyword">await</span> loadImageAsset()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Finally, when the view disappears, we need to free it </span></span><br><span class="line">        <span class="comment">// up from the memory</span></span><br><span class="line">        .onDisappear &#123;</span><br><span class="line">            image <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此照片<code>GridItem</code>从 iOS 15 开始支持并发 API，并使用内置任务支持来允许 SwiftUI 视图与并发 API 交互。当此视图加载时，视图生命周期会触发<code>loadImageAsset()</code>任务，该任务将要求 PhotoKit 使用本地资产 ID 获取照片的副本。当<code>GridItem</code>超出可视滚动区域时，图像将从内存中释放，因此它不会不必要地累积内存使用量，模仿<code>UICollectionView</code>的单元格重用机制。</p>
<p>在这篇文章中，您了解了<code>LazyVGrid</code>的内置内存管理机制，并通过添加 UIKit 视图具有的单元格重用机制改进了其内存管理行为。</p>
<p>在本系列的下一部分中，我们将继续构建网格 UI 以使用<code>PhotoThumbnailView</code>作为<code>LazyVGrid</code>的<code>GridItem</code> 。我希望您从这篇文章中学到了很多东西。我们下一场见！</p>
<h1 id="第-3-部分：创建照片库应用程序"><a href="#第-3-部分：创建照片库应用程序" class="headerlink" title="第 3 部分：创建照片库应用程序"></a>第 3 部分：创建照片库应用程序</h1><p>在这篇文章中，我们将继续构建网格 UI，以使用 PhotoThumbnailView 作为 LazyVGrid 的 GridItem，并在从网格中选择照片时导航到照片详细信息视图。</p>
<p>您好，欢迎回来！这是<strong>在 SwiftUI 中构建照片库应用程序</strong>系列的第 4 部分，共 4 部分。</p>
<p>在本系列的第 2 部分中，您了解了<code>LazyVGrid</code> （延迟加载）和<code>UICollectionView</code> （单元格重用机制）的内置内存管理机制，并使用这些知识来改进<code>LazyVGrid</code>的默认行为，以释放滚动超过的所有项目。可视区域以节省内存以免累积。</p>
<p>在这篇文章中，我们将继续构建网格 UI，以使用<code>PhotoThumbnailView</code>作为<code>LazyVGrid</code>的<code>GridItem</code> ，并在从网格中选择照片时导航到照片详细信息视图。</p>
<h3 id="图书馆景观"><a href="#图书馆景观" class="headerlink" title="图书馆景观"></a>图书馆景观</h3><img src="https://user-images.githubusercontent.com/106976715/189639356-ab043d14-b5ac-4217-a19f-cd655f43ef33.png" width="360" alt="simulator_screenshot_5BB5921D-1BD7-4BAE-BDF1-98EEAA11C7A4">

<p>库视图使用包含在<code>ScrollView</code>中的<code>LazyVGrid</code> ，因此它是可滚动的。对于每个照片项目，我们将使用我们在本系列的第 2 部分中创建的<code>PhotoThumbnailView</code> 。为了让您快速回顾一下， <code>PhotoThumbnailView</code>使用 PhotoKit 从库中获取照片，并在不再需要时释放照片以避免内存使用的累积。我们可以保证，当<code>PhotoThumbnailView</code>显示在屏幕上时，它会为我们获取并显示照片，并且当它滚动经过可视区域时，它将从内存中释放。</p>
<p>首先，我们首先在 SwiftUI 中创建<code>PhotoLibraryView</code> ：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoLibraryView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span>	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要添加<code>PhotoLibraryService</code> ，因为我们需要请求用户授予访问用户照片库的权限。一旦获得许可，我们将使用<code>PhotoLibraryService</code>通过 PhotoKit 从库中获取所有照片引用。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoLibraryView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="comment">/// Photo library will ask for permission to ask the user for </span></span><br><span class="line">	<span class="comment">/// Photo access, and will provide the photos as well.</span></span><br><span class="line">    <span class="meta">@EnvironmentObject</span> <span class="keyword">var</span> photoLibraryService: <span class="type">PhotoLibraryService</span></span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户可能会撤销或拒绝对照片库的访问，我们也必须能够在 UI 上处理此问题。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoLibraryView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    <span class="comment">/// Frag that will show the error prompt if the user does not </span></span><br><span class="line">    <span class="comment">/// grant the app Photo access.</span></span><br><span class="line">    <span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> showErrorPrompt <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们添加代码，显示访问照片库的提示，并正确处理用户拒绝访问照片库时的情况。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoLibraryView</span> &#123;</span><br><span class="line">	<span class="keyword">func</span> <span class="title function_">requestForAuthorizationIfNecessary</span>() &#123;</span><br><span class="line">        <span class="comment">// Make sure that the access granted by the user is </span></span><br><span class="line">        <span class="comment">// authorized, or limited access to make the app work. As </span></span><br><span class="line">        <span class="comment">// long as access is granted, even when limited, we can have </span></span><br><span class="line">        <span class="comment">// the photo library fetch the photos to be shown in the app.</span></span><br><span class="line">        <span class="keyword">guard</span> photoLibraryService.authorizationStatus <span class="operator">!=</span> .authorized <span class="operator">||</span></span><br><span class="line">                photoLibraryService.authorizationStatus <span class="operator">!=</span> .limited</span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        photoLibraryService.requestAuthorization &#123; error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> error <span class="operator">!=</span> <span class="literal">nil</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            showErrorPrompt <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来要做的就是创建 UI 本身。为了便于阅读，我们将其作为计算属性来执行。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoLibraryView</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> libraryView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">ScrollView</span> &#123;</span><br><span class="line">            <span class="type">LazyVGrid</span>(</span><br><span class="line">	            <span class="comment">/// We&#x27;ll set a 3-column row with an adaptive width</span></span><br><span class="line">	            <span class="comment">/// of 100 for each grid item, and give it a spacing</span></span><br><span class="line">	            <span class="comment">/// of 1 pixel in between columns and in between rows</span></span><br><span class="line">                columns: <span class="type">Array</span>(</span><br><span class="line">	                repeating: .<span class="keyword">init</span>(.adaptive(minimum: <span class="number">100</span>), spacing: <span class="number">1</span>), </span><br><span class="line">		            count: <span class="number">3</span></span><br><span class="line">		        ),</span><br><span class="line">                spacing: <span class="number">1</span></span><br><span class="line">            ) &#123;</span><br><span class="line">	            <span class="comment">/// We&#x27;ll go through the photo references fetched by</span></span><br><span class="line">	            <span class="comment">/// the photo gallery and give a photo asset ID</span></span><br><span class="line">	            <span class="comment">/// into the PhotoThumbnailView so it knows what</span></span><br><span class="line">	            <span class="comment">/// image to load and show into the grid</span></span><br><span class="line">                <span class="type">ForEach</span>(photoLibraryService.results, id: \.<span class="keyword">self</span>) &#123; asset <span class="keyword">in</span></span><br><span class="line">	                <span class="comment">/// Wrap the PhotoThumbnailView into a button</span></span><br><span class="line">	                <span class="comment">/// so we can tap on it without overlapping</span></span><br><span class="line">	                <span class="comment">/// the tap area of each photo, as photos have</span></span><br><span class="line">	                <span class="comment">/// their aspect ratios, and may go out of</span></span><br><span class="line">	                <span class="comment">/// bounds of the square view.</span></span><br><span class="line">                    <span class="type">Button</span> &#123;</span><br><span class="line">						<span class="comment">// <span class="doctag">TODO:</span> Add tapping action here</span></span><br><span class="line">                    &#125; label: &#123;</span><br><span class="line">                        <span class="type">PhotoThumbnailView</span>(assetLocalId: asset.localIdentifier)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将<code>libraryView</code>属性添加到<code>PhotoLibraryView</code>的<code>body</code>中。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoLibraryView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">ZStack</span> &#123;</span><br><span class="line">            <span class="comment">// We&#x27;ll show the photo library in a grid</span></span><br><span class="line">            libraryView</span><br><span class="line">                .onAppear &#123;</span><br><span class="line">                    <span class="comment">// But first we need to make sure we got </span></span><br><span class="line">                    <span class="comment">// permission to Access the Photos library</span></span><br><span class="line">                    requestForAuthorizationIfNecessary()</span><br><span class="line">                &#125;</span><br><span class="line">                .alert(</span><br><span class="line">                    <span class="comment">// If in case the user won&#x27;t grant permission, </span></span><br><span class="line">                    <span class="comment">// we&#x27;ll show an alert to notify the user that </span></span><br><span class="line">                    <span class="comment">// access is required to use the app.</span></span><br><span class="line">                    <span class="type">Text</span>(<span class="string">&quot;This app requires photo library access to show your photos&quot;</span>),</span><br><span class="line">                    isPresented: <span class="variable">$showErrorPrompt</span></span><br><span class="line">                ) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们有了库视图，继续尝试在手机或模拟器中运行该应用程序。如果您授予照片库访问权限，您应该能够在应用程序上查看您的照片。</p>
<h3 id="详细视图"><a href="#详细视图" class="headerlink" title="详细视图"></a>详细视图</h3><p>详细视图将是另一个 SwiftUI，它将转换从<code>PhotoLibraryView</code>中选择的照片。所选照片将集中在详细视图上。在本系列的下一部分中，我们将向详细视图添加更多功能，但现在让我们创建 UI。我们将详细视图称为<code>PhotoDetailView</code> 。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如本系列第 1 部分中所讨论的，我们应该避免传递实际照片本身，而应该在视图之间传递照片引用。我们之前已经在<code>PhotoLibraryView</code>和<code>PhotoThumbnailView</code>上实现了这种方法。 <code>PhotoLibraryView</code>将告诉 PhotoKit 通过<code>PhotoLibraryService</code>获取所有照片引用，并且每个<code>PhotoThumbnailView</code>都可以访问本地照片资源 ID。然后， <code>PhotoThumbnailView</code>使用本地资产 ID 使用<code>PhotoLibraryService</code>的抽象从 PhotoKit 获取实际照片本身。</p>
<p>使用相同的方法，我们需要将照片本地资产 ID 从<code>PhotoLibraryView</code>传递到<code>PhotoDetailView</code>中，并让<code>PhotoDetailView</code>使用<code>PhotoLibraryService</code>获取照片的缓存副本。</p>
<p>让我们首先将<code>PhotoLibraryService</code>添加到<code>PhotoDetailView</code>中。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="meta">@EnvironmentObject</span> <span class="keyword">var</span> photoLibraryService: <span class="type">PhotoLibraryService</span></span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还添加了使用资产本地 ID 获取照片本身的缓存副本的功能。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">	<span class="keyword">func</span> <span class="title function_">loadImageAsset</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> uiImage <span class="operator">=</span> <span class="keyword">try?</span> <span class="keyword">await</span> photoLibraryService.fetchImage(</span><br><span class="line">            byLocalIdentifier: assetLocalId</span><br><span class="line">        ) <span class="keyword">else</span> &#123;</span><br><span class="line">            image <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        image <span class="operator">=</span> <span class="type">Image</span>(uiImage: uiImage)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们将添加一个属性，该属性可以保存对照片资源本地 ID 的引用，以便它知道要使用<code>PhotoLibraryService</code>获取哪些照片。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    <span class="comment">/// The reference id of the selected photo</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> assetLocalId: <span class="type">PhotoLibraryService</span>.<span class="type">PHAssetLocalIdentifier</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(</span><br><span class="line">        <span class="params">assetLocalId</span>: <span class="type">PhotoLibraryService</span>.<span class="type">PHAssetLocalIdentifier</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">self</span>.assetLocalId <span class="operator">=</span> assetLocalId</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还想添加一个可选<code>Image</code> ，因为在<code>PhotoLibraryService</code>完成获取图像的缓存副本之前，我们不一定要显示照片的副本。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">    <span class="comment">/// The image view that will render the photo that we&#x27;ll fetch </span></span><br><span class="line">    <span class="comment">/// later on. It is set to optional since we don&#x27;t have an actual </span></span><br><span class="line">    <span class="comment">/// photo when this scene starts to render. We need to give time </span></span><br><span class="line">    <span class="comment">/// for the photo library service to fetch a cached copy</span></span><br><span class="line">    <span class="comment">/// of the photo using the asset id, so we&#x27;ll set the image with </span></span><br><span class="line">    <span class="comment">/// the fetching photo at a later time.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Fetching is generally fast, as photos are cached at this </span></span><br><span class="line">    <span class="comment">/// point. So you don&#x27;t need to worry about photo rendering.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Also, we would want to free up the image from the memory when </span></span><br><span class="line">    <span class="comment">/// this view disappears to save up memory.</span></span><br><span class="line">    <span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> image: <span class="type">Image</span>?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 UI，我们将创建<code>photoView</code>并将其作为计算属性以提高可读性。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> photoView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">GeometryReader</span> &#123; proxy <span class="keyword">in</span></span><br><span class="line">            image<span class="operator">?</span></span><br><span class="line">                .resizable()</span><br><span class="line">                .aspectRatio(contentMode: .fit)</span><br><span class="line">                .frame(width: proxy.size.width <span class="operator">*</span> <span class="built_in">max</span>(minZoomScale, zoomScale))</span><br><span class="line">                .frame(maxHeight: .infinity)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们将在<code>PhotoDetailView</code> <code>body</code>内使用<code>photoView</code> 。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">ZStack</span> &#123;</span><br><span class="line">            <span class="comment">// We&#x27;ll need a black background regardless of the </span></span><br><span class="line">            <span class="comment">// environment&#x27;s colour scheme.</span></span><br><span class="line">            <span class="type">Color</span>.black</span><br><span class="line">                .ignoresSafeArea()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Show the image if it&#x27;s available</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">_</span> <span class="operator">=</span> image &#123;</span><br><span class="line">                photoView</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// otherwise, show a spinning progress view</span></span><br><span class="line">                <span class="type">ProgressView</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We need to use the task to work on a concurrent request to </span></span><br><span class="line">        <span class="comment">// load the image from the photo library service, which is an </span></span><br><span class="line">        <span class="comment">// asynchronous work.</span></span><br><span class="line">        .task &#123;</span><br><span class="line">            <span class="keyword">await</span> loadImageAsset()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Finally, when the view disappears, we need to free it up </span></span><br><span class="line">        <span class="comment">// from the memory</span></span><br><span class="line">        .onDisappear &#123;</span><br><span class="line">            image <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="选择照片并进行过渡"><a href="#选择照片并进行过渡" class="headerlink" title="选择照片并进行过渡"></a>选择照片并进行过渡</h3><p>现在我们已经有了<code>PhotoLibraryView</code>和<code>PhotoDetailView</code> ，我们需要在选择照片时在两个视图之间添加过渡。</p>
<p>让我们首先向<code>PhotoDetailView</code>添加必要的更改</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="comment">/// Flag that will close the detail view if set to false</span></span><br><span class="line">    <span class="meta">@Binding</span> <span class="keyword">var</span> showDetailView: <span class="type">Bool</span></span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">    <span class="comment">/// Update your init to accept showDetailView binding</span></span><br><span class="line">	<span class="keyword">init</span>(</span><br><span class="line">        <span class="params">assetLocalId</span>: <span class="type">PhotoLibraryService</span>.<span class="type">PHAssetLocalIdentifier</span>,</span><br><span class="line">        <span class="params">showDetailView</span>: <span class="type">Binding</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">self</span>.assetLocalId <span class="operator">=</span> assetLocalId</span><br><span class="line">        <span class="keyword">self</span>._showDetailView <span class="operator">=</span> showDetailView</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们还需要为关闭按钮添加其他子视图，以便在按下关闭按钮时可以从<code>PhotoDetailView</code>转换回<code>PhotoLibraryView</code> 。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> photoView: <span class="keyword">some</span> <span class="type">View</span> &#123; <span class="operator">...</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> toolbarView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">HStack</span> &#123;</span><br><span class="line">            closeButton</span><br><span class="line">        &#125;</span><br><span class="line">        .frame(maxWidth: .infinity, alignment: .trailing)</span><br><span class="line">        .padding(.horizontal, <span class="number">20</span>)</span><br><span class="line">        .frame(height: <span class="number">44</span>)</span><br><span class="line">        .frame(maxHeight: .infinity, alignment: .top)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> closeButton: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">Button</span> &#123;</span><br><span class="line">            showDetailView <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        &#125; label: &#123;</span><br><span class="line">            <span class="type">Image</span>(systemName: <span class="string">&quot;xmark&quot;</span>)</span><br><span class="line">                .font(.body.bold())</span><br><span class="line">                .aspectRatio(contentMode: .fit)</span><br><span class="line">                .foregroundColor(.white)</span><br><span class="line">                .frame(width: <span class="number">16</span>, height: <span class="number">16</span>)</span><br><span class="line">                .padding(.all, <span class="number">12</span>)</span><br><span class="line">                .background(.ultraThinMaterial, in: <span class="type">Circle</span>())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们将工具栏添加到<code>body</code>中，以便当<code>PhotoDetailView</code>显示在屏幕上时它将包含在内。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">ZStack</span> &#123;</span><br><span class="line">            <span class="comment">// We&#x27;ll need a black background regardless of the </span></span><br><span class="line">            <span class="comment">// environment&#x27;s colour scheme.</span></span><br><span class="line">            <span class="type">Color</span>.black</span><br><span class="line">                .ignoresSafeArea()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Show the image if it&#x27;s available</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">_</span> <span class="operator">=</span> image &#123;</span><br><span class="line">                photoView</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// otherwise, show a spinning progress view</span></span><br><span class="line">                <span class="type">ProgressView</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// The toolbar view holds the close button</span></span><br><span class="line">        .overlay(</span><br><span class="line">            toolbarView</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// We need to use a task to work on a concurrent request to </span></span><br><span class="line">        <span class="comment">// load the image from the photo library service, which is an </span></span><br><span class="line">        <span class="comment">// asynchronous work.</span></span><br><span class="line">        .task &#123;</span><br><span class="line">            <span class="keyword">await</span> loadImageAsset()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Finally, when the view disappears, we need to free it up </span></span><br><span class="line">        <span class="comment">// from the memory</span></span><br><span class="line">        .onDisappear &#123;</span><br><span class="line">            image <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们回到<code>PhotoLibraryView</code>以便我们也可以对过渡进行更改。</p>
<p>我们首先添加一个新的<code>Boolean</code>状态（用于确定是否显示<code>PhotoDetailView</code> ，以及一个用于保存所选照片的照片资源 ID 引用的状态。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoLibraryView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    <span class="comment">/// Flag that will show the detail view when a photo is selected </span></span><br><span class="line">    <span class="comment">/// from the grid.</span></span><br><span class="line">    <span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> showDetailView <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Selecting a photo from the grid will show a detail view where </span></span><br><span class="line">    <span class="comment">/// the user can zoom/pan.</span></span><br><span class="line">    <span class="comment">/// To do so, we store a reference to the selected photo </span></span><br><span class="line">    <span class="comment">/// here.</span></span><br><span class="line">    <span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> selectedPhotoAssetId: <span class="type">PhotoLibraryService</span>.<span class="type">PHAssetLocalIdentifier</span> <span class="operator">=</span> .empty</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要为<code>PhotoDetailView</code>添加一个新的子视图，这样当从网格中选择照片时，我们就可以将其放在<code>ZStack</code>的顶部。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoLibraryView</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> libraryView: <span class="keyword">some</span> <span class="type">View</span> &#123; <span class="operator">...</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> detailView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">ForEach</span>(photoLibraryService.results, id: \.<span class="keyword">self</span>) &#123; asset <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> asset.localIdentifier <span class="operator">==</span> selectedPhotoAssetId &#123;</span><br><span class="line">                <span class="type">PhotoDetailView</span>(</span><br><span class="line">                    assetLocalId: selectedPhotoAssetId,</span><br><span class="line">                    showDetailView: <span class="variable">$showDetailView</span></span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// We need to make sure that the detail view gets the </span></span><br><span class="line">                <span class="comment">// top layer of the ZStack when rendering. We don&#x27;t </span></span><br><span class="line">                <span class="comment">// want to hide the detail view underneath the photo </span></span><br><span class="line">                <span class="comment">// grid when we select a photo. So we&#x27;ll assign it a </span></span><br><span class="line">                <span class="comment">// higher zIndex value.</span></span><br><span class="line">                .zIndex(<span class="number">1</span>)</span><br><span class="line">                <span class="comment">// We would also want to add a small transition </span></span><br><span class="line">                <span class="comment">// easeIn/easeOut animations during the</span></span><br><span class="line">                <span class="comment">// photo grid to detail view transition and vice </span></span><br><span class="line">                <span class="comment">// versa.</span></span><br><span class="line">                .transition(</span><br><span class="line">                    .asymmetric(</span><br><span class="line">                        insertion: .opacity.animation(.easeIn),</span><br><span class="line">                        removal: .opacity.animation(.easeOut)</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要更新<code>libraryView</code>以在从照片网格中点击<code>PhotoThumbnailView</code>时设置一些<code>Button</code>操作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoLibraryView</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> libraryView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">ScrollView</span> &#123;</span><br><span class="line">            <span class="type">LazyVGrid</span>(<span class="operator">...</span>) &#123;</span><br><span class="line">                <span class="type">ForEach</span>(photoLibraryService.results, id: \.<span class="keyword">self</span>) &#123; asset <span class="keyword">in</span></span><br><span class="line">                    <span class="type">Button</span> &#123;</span><br><span class="line">						<span class="comment">/// Add them here</span></span><br><span class="line">                        showDetailView <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">                        selectedPhotoAssetId <span class="operator">=</span> asset.localIdentifier				</span><br><span class="line">                    &#125; label: &#123;</span><br><span class="line">                        <span class="type">PhotoThumbnailView</span>(assetLocalId: asset.localIdentifier)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> detailView: <span class="keyword">some</span> <span class="type">View</span> &#123; <span class="operator">...</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，当从网格中选择照片时，我们需要将<code>PhotoDetailView</code>包含在<code>PhotoLibraryView</code>的<code>ZStack</code>中。为此，我们需要更新<code>body</code>以包括：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoLibraryView</span>: <span class="title class_">some</span> <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">		<span class="type">ZStack</span> &#123;</span><br><span class="line">			libraryView</span><br><span class="line">				.onAppear &#123; <span class="operator">...</span> &#125;</span><br><span class="line">				.alert(<span class="operator">...</span>) &#123;&#125;</span><br><span class="line">			</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// We&#x27;ll show the detail view on top of the ZStack if a </span></span><br><span class="line">            <span class="comment">// photo is selected</span></span><br><span class="line">            <span class="keyword">if</span> showDetailView &#123;</span><br><span class="line">                detailView</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时您可以尝试再次运行该应用程序，并且您应该能够从网格中选择一张照片。所选照片应显示在<code>PhotoDetailView</code>中，当您按返回时，您还应导航回<code>PhotoLibraryView</code> 。</p>
<p>在这篇文章中，我们整理了之前构建的内容并为照片库应用程序创建了 UI。我们现在有了一个内存高性能照片网格，并且我们还确保通过引用传递照片不会导致我们的内存出现任何重复。</p>
<p>在本系列的下一部分也是最后一部分中，我将向您展示如何添加多个手势，以便我们可以提供双击缩放、捏合缩放和平移照片等功能。我希望到目前为止您喜欢阅读该系列。我们下一场见！</p>
<h1 id="第-4-部分：添加多个手势"><a href="#第-4-部分：添加多个手势" class="headerlink" title="第 4 部分：添加多个手势"></a>第 4 部分：添加多个手势</h1><p>在这篇文章中，我将向您展示如何添加多个手势，以便我们可以提供双击缩放、捏合缩放和平移照片等功能。</p>
<p>您好，欢迎回来！这是<strong>在 SwiftUI 中构建照片库应用程序</strong>系列的最后一部分。</p>
<p>在本系列的第 3 部分中，我们已经完成了照片库应用程序的 UI，其中包含显示照片网格的<code>PhotoLibraryView</code> 、作为<code>GridItem</code>的<code>PhotoThumbnailView</code>以及专注于从网格中选择的图像的<code>PhotoDetailView</code> 。但是， <code>PhotoDetailView</code>缺乏手势支持，并且我们没有任何用于检查照片的交互支持，例如缩放或平移。如果不支持这些手势，照片库应用程序就不完整。</p>
<p>在这篇文章中，我将向您展示如何添加多个手势，以便我们可以提供双击缩放、捏合缩放和平移照片等功能。</p>
<h3 id="双击缩放"><a href="#双击缩放" class="headerlink" title="双击缩放"></a>双击缩放</h3><p>添加对双击缩放的支持非常容易。我们首先需要添加<code>@State</code>属性，用于存储<code>zoomScale</code>值，以便我们可以判断照片是否缩放以及对照片应用了多少缩放。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    <span class="comment">/// Zooming value modifiers that are set by pinching to zoom </span></span><br><span class="line">    <span class="comment">/// gestures</span></span><br><span class="line">    <span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> zoomScale: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> previousZoomScale: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> minZoomScale: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> maxZoomScale: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">5</span></span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们创建一个函数，在收到双击手势时缩放照片，并将缩放状态重置回正常状态。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">	<span class="comment">/// Resets the zoom scale back to 1 – the photo scale at 1x zoom</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">resetImageState</span>() &#123;</span><br><span class="line">        withAnimation(.interactiveSpring()) &#123;</span><br><span class="line">            zoomScale <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/// On double tap</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">onImageDoubleTapped</span>() &#123;</span><br><span class="line">	    <span class="comment">/// Zoom the photo to 5x scale if the photo isn&#x27;t zoomed in</span></span><br><span class="line">        <span class="keyword">if</span> zoomScale <span class="operator">==</span> <span class="number">1</span> &#123;</span><br><span class="line">            withAnimation(.spring()) &#123;</span><br><span class="line">                zoomScale <span class="operator">=</span> <span class="number">5</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	        <span class="comment">/// Otherwise, reset the photo zoom to 1x</span></span><br><span class="line">            resetImageState()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们将使用<code>onTapGesture(count, perform)</code>函数向<code>photoView</code>添加对双击手势的支持。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> photoView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">GeometryReader</span> &#123; proxy <span class="keyword">in</span></span><br><span class="line">            image<span class="operator">?</span></span><br><span class="line">                .resizable()</span><br><span class="line">                .aspectRatio(contentMode: .fit)</span><br><span class="line">                .onTapGesture(count: <span class="number">2</span>, perform: onImageDoubleTapped)</span><br><span class="line">                .frame(width: proxy.size.width <span class="operator">*</span> <span class="built_in">max</span>(minZoomScale, zoomScale))</span><br><span class="line">                .frame(maxHeight: .infinity)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行应用程序并双击<code>PhotoDetailView</code>上的照片。您会注意到它会在缩放状态和正常状态之间来回切换。</p>
<p>接下来是添加对捏合缩放手势的支持。 SwiftUI 通过一个名为<code>MagnificationGesture</code>的内置手势默认支持捏合手势，这是一件很棒的事情，并且添加它很容易。</p>
<p>在将<code>MagnificationGesture</code>添加到<code>photoView</code>之前，我们首先需要定义<code>MagnificationGesture</code>行为所需的函数。</p>
<p>要使用<code>MagnificationGesture</code> ，我们需要定义手势开始和结束时其行为。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">onZoomGestureStarted</span>(<span class="params">value</span>: <span class="type">MagnificationGesture</span>.<span class="type">Value</span>) &#123;</span><br><span class="line">        withAnimation(.easeIn(duration: <span class="number">0.1</span>)) &#123;</span><br><span class="line">            <span class="keyword">let</span> delta <span class="operator">=</span> value <span class="operator">/</span> previousZoomScale</span><br><span class="line">            previousZoomScale <span class="operator">=</span> value</span><br><span class="line">            <span class="keyword">let</span> zoomDelta <span class="operator">=</span> zoomScale <span class="operator">*</span> delta</span><br><span class="line">            <span class="keyword">var</span> minMaxScale <span class="operator">=</span> <span class="built_in">max</span>(minZoomScale, zoomDelta)</span><br><span class="line">            minMaxScale <span class="operator">=</span> <span class="built_in">min</span>(maxZoomScale, minMaxScale)</span><br><span class="line">            zoomScale <span class="operator">=</span> minMaxScale</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">onZoomGestureEnded</span>(<span class="params">value</span>: <span class="type">MagnificationGesture</span>) &#123;</span><br><span class="line">        previousZoomScale <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> zoomScale <span class="operator">&lt;=</span> <span class="number">1</span> &#123;</span><br><span class="line">            resetImageState()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> zoomScale <span class="operator">&gt;</span> <span class="number">5</span> &#123;</span><br><span class="line">            zoomScale <span class="operator">=</span> <span class="number">5</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当手势开始时，我们将计算<code>zoomScale</code>以接受 1 倍原始比例和 5 倍缩放比例之间的值。我们不允许任何低于原始比例的值，以及任何大于缩放比例的值。</p>
<p>整个计算包含在<code>withAnimation()</code>闭包中，因此我们可以告诉 SwiftUI 我们需要在每次手势变化时平滑地设置缩放行为的动画。</p>
<p>当手势结束时，我们将保留<code>zoomScale</code> ，以便我们的照片根据手势输入进行缩放。</p>
<p>现在我们有了<code>onZoomGestureStarted</code>和<code>onZoomGestureEnded</code>函数来定义我们想要的行为，让我们将它们添加到<code>MagnificationGesture</code>对象上，并将其命名为<code>zoomGesture</code> 。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> zoomGesture: <span class="keyword">some</span> <span class="type">Gesture</span> &#123;</span><br><span class="line">        <span class="type">MagnificationGesture</span>()</span><br><span class="line">            .onChanged(onZoomGestureStarted)</span><br><span class="line">            .onEnded(onZoomGestureEnded)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将其作为手势添加到<code>photoView</code>中，如下所示：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> photoView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">GeometryReader</span> &#123; proxy <span class="keyword">in</span></span><br><span class="line">            image<span class="operator">?</span></span><br><span class="line">                .resizable()</span><br><span class="line">                .aspectRatio(contentMode: .fit)</span><br><span class="line">                .onTapGesture(count: <span class="number">2</span>, perform: onImageDoubleTapped)</span><br><span class="line">                .gesture(zoomGesture) <span class="comment">// Add it here</span></span><br><span class="line">                .frame(width: proxy.size.width <span class="operator">*</span> <span class="built_in">max</span>(minZoomScale, zoomScale))</span><br><span class="line">                .frame(maxHeight: .infinity)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行该应用程序，您应该能够捏合屏幕并进行缩放。但是，您可能已经注意到，您无法在滑动时平移或滚动照片以移动。为此，您可以添加<code>DragGesture</code>来存储拖动偏移，并将其应用到<code>photoView.offSet</code>修改器，以便它沿着您的平移手势移动。</p>
<p>但是，根据经验，这不是一个理想的解决方案，因为管理有关<code>PhotoDetailView</code>边界的照片偏移会很困难。您将需要根据<code>PhotoDetailView</code>的边界进行计算，以便<code>photoView</code>不会超出边界。</p>
<h3 id="添加-DragGesture-以支持平移（不推荐）"><a href="#添加-DragGesture-以支持平移（不推荐）" class="headerlink" title="添加 DragGesture 以支持平移（不推荐）"></a>添加 DragGesture 以支持平移（不推荐）</h3><p>您无需按照我的说明操作下面的示例，因为该示例仅向您展示如果您选择实现<code>DragGesture</code>来添加平移手势支持，会出现什么问题。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhotoDetailView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">	<span class="comment">// Add a new dragOffset property to store your drag gesture</span></span><br><span class="line">	<span class="comment">// movement updates</span></span><br><span class="line">	<span class="meta">@State</span> <span class="keyword">private</span> <span class="keyword">var</span> dragOffset: <span class="type">CGSize</span> <span class="operator">=</span> .zero</span><br><span class="line">	<span class="operator">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">	<span class="operator">...</span>   </span><br><span class="line">	<span class="comment">// Then declare a function that will store the new offset</span></span><br><span class="line">	<span class="comment">// based on the actual movement of the user</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">onDragGestureStarted</span>(<span class="params">value</span>: <span class="type">DragGesture</span>.<span class="type">Value</span>) &#123;</span><br><span class="line">        withAnimation(.easeIn(duration: <span class="number">0.1</span>)) &#123;</span><br><span class="line">            dragOffset <span class="operator">=</span> value.translation</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Declare the `DragGesture` object, and assign the drag changed</span></span><br><span class="line">	<span class="comment">// behaviour above.</span></span><br><span class="line">	<span class="keyword">var</span> panGesture: <span class="keyword">some</span> <span class="type">Gesture</span> &#123;</span><br><span class="line">		<span class="type">DragGesture</span>()</span><br><span class="line">			.onChanged(onDragGestureStarted)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Lastly, assign the pan gesture to the `photoView`</span></span><br><span class="line">    <span class="keyword">var</span> photoView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">GeometryReader</span> &#123; proxy <span class="keyword">in</span></span><br><span class="line">            image<span class="operator">?</span></span><br><span class="line">                .resizable()</span><br><span class="line">                .aspectRatio(contentMode: .fit)</span><br><span class="line">                .onTapGesture(count: <span class="number">2</span>, perform: onImageDoubleTapped)</span><br><span class="line">                .gesture(panGesture) <span class="comment">// Add it here</span></span><br><span class="line">                .gesture(zoomGesture)</span><br><span class="line">                .frame(width: proxy.size.width <span class="operator">*</span> <span class="built_in">max</span>(minZoomScale, zoomScale))</span><br><span class="line">                .frame(maxHeight: .infinity)</span><br><span class="line">                .offset(dragOffset)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行应用程序然后观察。放大照片，然后朝您想要移动的方向滑动照片来执行平移手势。</p>
<p>照片应跟随您的拖动移动，但每次您释放拖动移动时，拖动偏移都会将照片移动到新位置。如果将照片移动到边缘，您会注意到照片可能会超出视图范围，这是我们不希望发生的情况。</p>
<img src="https://user-images.githubusercontent.com/106976715/190696381-a2ff87d0-c2cf-4a37-b558-cc8a812ab380.png" width="360" alt="Simulator Screen Shot - iPhone 13 mini - 2022-09-17 at 01 24 58">

<p>这是使用<code>DragGesture</code>实现的照片示例，滑动到照片的左上角，您可以看到顶部超出了视图容器顶部的范围。</p>
<h3 id="用-ScrollView-包裹它（推荐）"><a href="#用-ScrollView-包裹它（推荐）" class="headerlink" title="用 ScrollView 包裹它（推荐）"></a>用 ScrollView 包裹它（推荐）</h3><p>如果您想以最少的努力获得相同的结果，可以通过将<code>photoView</code>的<code>image</code>包装在<code>ScrollView</code>中并将滚动方向设置为<code>.horizontal</code>和<code>.vertical</code>来实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">PhotoDetailView</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> photoView: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">GeometryReader</span> &#123; proxy <span class="keyword">in</span></span><br><span class="line">	        <span class="comment">// Wrap the image with a scroll view.</span></span><br><span class="line">	        <span class="comment">// Doing so would limit the photo scroll within the</span></span><br><span class="line">	        <span class="comment">// bounds of the scroll view, but will still have</span></span><br><span class="line">	        <span class="comment">// the same functionality of adding pan gesture support.</span></span><br><span class="line">            <span class="type">ScrollView</span>(</span><br><span class="line">                [.vertical, .horizontal],</span><br><span class="line">                showsIndicators: <span class="literal">false</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                image<span class="operator">?</span></span><br><span class="line">                    .resizable()</span><br><span class="line">                    .aspectRatio(contentMode: .fit)</span><br><span class="line">                    .onTapGesture(count: <span class="number">2</span>, perform: onImageDoubleTapped)</span><br><span class="line">                    .gesture(zoomGesture)</span><br><span class="line">                    .frame(width: proxy.size.width <span class="operator">*</span> <span class="built_in">max</span>(minZoomScale, zoomScale))</span><br><span class="line">                    .frame(maxHeight: .infinity)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行应用程序，然后缩放照片。您应该能够滚动照片，同时将相框限制在其容器视图的范围内。将<code>image</code>包装到<code>ScrollView</code>中是解决相框和视图边界计算等复杂问题的极其简单的解决方案。</p>
<h3 id="您在开始开发照片库应用程序时需要帮助吗？"><a href="#您在开始开发照片库应用程序时需要帮助吗？" class="headerlink" title="您在开始开发照片库应用程序时需要帮助吗？"></a>您在开始开发照片库应用程序时需要帮助吗？</h3><p>如果您需要创建一个像本系列中的照片库应用程序，但您不确定如何自己开始，那么您可以购买我们的 CWC 代码套件之一。</p>
<p>照片库应用程序代码套件包含我们在本系列中讨论的所有内存管理最佳实践，并且是用 100% SwiftUI 编写的。您将从具有完整基本功能（包括内存性能）的照片库应用程序开始，这样您就可以专注于添加更多功能并使其成为您自己的！</p>
<p>我们还有适用于其他应用程序的套件，因此请在<a target="_blank" rel="noopener" href="https://codewithchris.wpengine.com/kits/">https://codewithchris.wpengine.com/kits</a>上查看我们的代码和设计套件。</p>
<p>本系列的最后一部分到此结束，我希望您已经学会了如何在 SwiftUI 中创建照片库应用程序！这是一段相当长的旅程，祝贺您走到这一步。希望您喜欢这个系列！感谢您的阅读！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/02/06/%E5%9C%A8%20SwiftUI%20%E4%B8%AD%E6%9E%84%E5%BB%BA%E7%85%A7%E7%89%87%E5%BA%93%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" data-id="cm6swyblm0038ik74cqt6ci8y" data-title="在 SwiftUI 中构建照片库应用程序" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/02/06/25%E5%B9%B4%E5%89%8D%E4%B8%AD%E5%A4%AE%E7%94%B5%E8%A7%86%E5%8F%B0%E5%B9%BF%E5%91%8A%E6%8A%A5%E4%BB%B7/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          25年前中央电视台广告报价
        
      </div>
    </a>
  
  
    <a href="/2025/02/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E9%A2%86%E5%9F%9F%E7%9A%84%E7%AE%97%E6%B3%95/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">计算机领域的算法</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SwiftUI/">SwiftUI</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BufferedReader/" rel="tag">BufferedReader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/InputStreamReader/" rel="tag">InputStreamReader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/" rel="tag">Mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PrintWriter/" rel="tag">PrintWriter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ServerSocket/" rel="tag">ServerSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socket/" rel="tag">Socket</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BufferedReader/" style="font-size: 10px;">BufferedReader</a> <a href="/tags/InputStreamReader/" style="font-size: 10px;">InputStreamReader</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/PrintWriter/" style="font-size: 10px;">PrintWriter</a> <a href="/tags/ServerSocket/" style="font-size: 20px;">ServerSocket</a> <a href="/tags/Socket/" style="font-size: 20px;">Socket</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">February 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/02/06/25%E5%B9%B4%E5%89%8D%E4%B8%AD%E5%A4%AE%E7%94%B5%E8%A7%86%E5%8F%B0%E5%B9%BF%E5%91%8A%E6%8A%A5%E4%BB%B7/">25年前中央电视台广告报价</a>
          </li>
        
          <li>
            <a href="/2025/02/06/%E5%9C%A8%20SwiftUI%20%E4%B8%AD%E6%9E%84%E5%BB%BA%E7%85%A7%E7%89%87%E5%BA%93%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/">在 SwiftUI 中构建照片库应用程序</a>
          </li>
        
          <li>
            <a href="/2025/02/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E9%A2%86%E5%9F%9F%E7%9A%84%E7%AE%97%E6%B3%95/">计算机领域的算法</a>
          </li>
        
          <li>
            <a href="/2024/08/19/%E5%9C%A8SwiftUI%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%EF%BC%9F/">在SwiftUI中如何计算代码的执行时间？</a>
          </li>
        
          <li>
            <a href="/2024/08/19/SwiftUI%E4%B8%AD%E7%9A%84scrollTransition%E4%BF%AE%E9%A5%B0%E7%AC%A6%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8%EF%BC%9F/">SwiftUI中的scrollTransition修饰符怎么使用？</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>